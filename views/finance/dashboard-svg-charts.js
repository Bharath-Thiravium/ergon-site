const COLORS={primary:'#2563eb',success:'#10b981',warning:'#f59e0b',danger:'#ef4444',neutral:'#64748b'};function safeNum(v){if(v===null||v===undefined||v==='')return 0;if(typeof v==='number')return v;const n=Number(String(v).replace(/[^0-9.\-]/g,''));return Number.isFinite(n)?n:0}async function apiGet(url){try{const res=await fetch(url,{cache:'no-store'});if(!res.ok)return null;const json=await res.json();return json.success===false?null:json.data??null}catch(err){return null}}function getApiUrl(endpoint,prefix){const url=new URL(endpoint,window.location.origin);if(prefix)url.searchParams.set('prefix',prefix);return url.toString()}function addTooltip(el,text){el.addEventListener('mouseenter',e=>{const tooltip=document.createElement('div');tooltip.className='absolute bg-gray-900 text-white text-xs px-2 py-1 rounded pointer-events-none';tooltip.textContent=text;tooltip.style.left=e.pageX+'px';tooltip.style.top=(e.pageY-30)+'px';document.body.appendChild(tooltip);el._tooltip=tooltip});el.addEventListener('mouseleave',()=>{if(el._tooltip){el._tooltip.remove();delete el._tooltip}})}function drawDoughnut(svgId,data,colors,labels){const svg=document.getElementById(svgId);if(!svg)return;svg.innerHTML='';const total=data.reduce((a,b)=>a+b,0);if(total===0){svg.innerHTML='<circle cx="100" cy="60" r="30" fill="none" stroke="#e5e7eb" stroke-width="8"/><text x="100" y="65" text-anchor="middle" font-size="12" fill="#999">No data</text>';return}let angle=-Math.PI/2;const cx=100,cy=60,r=35,innerR=20;const paths=[];data.forEach((val,i)=>{const sliceAngle=val/total*2*Math.PI;const x1=cx+r*Math.cos(angle);const y1=cy+r*Math.sin(angle);const ix1=cx+innerR*Math.cos(angle);const iy1=cy+innerR*Math.sin(angle);angle+=sliceAngle;const x2=cx+r*Math.cos(angle);const y2=cy+r*Math.sin(angle);const ix2=cx+innerR*Math.cos(angle);const iy2=cy+innerR*Math.sin(angle);const largeArc=sliceAngle>Math.PI?1:0;const path=`M ${x1} ${y1} A ${r} ${r} 0 ${largeArc} 1 ${x2} ${y2} L ${ix2} ${iy2} A ${innerR} ${innerR} 0 ${largeArc} 0 ${ix1} ${iy1} Z`;const pathEl=document.createElementNS('http://www.w3.org/2000/svg','path');pathEl.setAttribute('d',path);pathEl.setAttribute('fill',colors[i]);pathEl.setAttribute('stroke','white');pathEl.setAttribute('stroke-width','2');pathEl.style.cursor='pointer';pathEl.style.opacity='0.8';pathEl.addEventListener('mouseenter',()=>{pathEl.style.opacity='1';pathEl.style.filter='brightness(1.1)'});pathEl.addEventListener('mouseleave',()=>{pathEl.style.opacity='0.8';pathEl.style.filter='brightness(1)'});addTooltip(pathEl,`${labels[i]}: ${val} (${Math.round(val/total*100)}%)`);svg.appendChild(pathEl);paths.push({label:labels[i],value:val,color:colors[i]})});const legend=document.createElement('div');legend.className='flex flex-wrap gap-2 mt-2 text-xs';paths.forEach(p=>{const item=document.createElement('div');item.className='flex items-center gap-1';const box=document.createElement('div');box.className='w-3 h-3 rounded-sm';box.style.backgroundColor=p.color;const text=document.createElement('span');text.textContent=`${p.label}: ${p.value}`;item.appendChild(box);item.appendChild(text);legend.appendChild(item)});svg.parentElement.appendChild(legend)}function drawGauge(svgId,fulfilled,total){const svg=document.getElementById(svgId);if(!svg)return;svg.innerHTML='';const rate=total>0?fulfilled/total:0;const cx=100,cy=80,r=35;const startAngle=-Math.PI;const endAngle=0;const filledAngle=startAngle+rate*(endAngle-startAngle);const x1=cx+r*Math.cos(startAngle);const y1=cy+r*Math.sin(startAngle);const x2=cx+r*Math.cos(filledAngle);const y2=cy+r*Math.sin(filledAngle);const x3=cx+r*Math.cos(endAngle);const y3=cy+r*Math.sin(endAngle);const largeArc1=rate>0.5?1:0;const path1=`M ${x1} ${y1} A ${r} ${r} 0 ${largeArc1} 1 ${x2} ${y2}`;const pathEl1=document.createElementNS('http://www.w3.org/2000/svg','path');pathEl1.setAttribute('d',path1);pathEl1.setAttribute('stroke',COLORS.success);pathEl1.setAttribute('stroke-width','8');pathEl1.setAttribute('fill','none');pathEl1.style.cursor='pointer';addTooltip(pathEl1,`Fulfilled: ${fulfilled}/${total}`);svg.appendChild(pathEl1);const largeArc2=(1-rate)>0.5?1:0;const path2=`M ${x2} ${y2} A ${r} ${r} 0 ${largeArc2} 1 ${x3} ${y3}`;const pathEl2=document.createElementNS('http://www.w3.org/2000/svg','path');pathEl2.setAttribute('d',path2);pathEl2.setAttribute('stroke','#e5e7eb');pathEl2.setAttribute('stroke-width','8');pathEl2.setAttribute('fill','none');svg.appendChild(pathEl2);const text=document.createElementNS('http://www.w3.org/2000/svg','text');text.setAttribute('x','100');text.setAttribute('y','75');text.setAttribute('text-anchor','middle');text.setAttribute('font-size','20');text.setAttribute('font-weight','bold');text.setAttribute('fill',COLORS.primary);text.textContent=Math.round(rate*100)+'%';svg.appendChild(text);const legend=document.createElement('div');legend.className='flex gap-4 mt-2 text-xs';const fulfilled_item=document.createElement('div');fulfilled_item.className='flex items-center gap-1';const fulfilled_box=document.createElement('div');fulfilled_box.className='w-3 h-3 rounded-sm';fulfilled_box.style.backgroundColor=COLORS.success;fulfilled_item.appendChild(fulfilled_box);fulfilled_item.appendChild(document.createTextNode(`Fulfilled: ${fulfilled}`));legend.appendChild(fulfilled_item);const open_item=document.createElement('div');open_item.className='flex items-center gap-1';const open_box=document.createElement('div');open_box.className='w-3 h-3 rounded-sm';open_box.style.backgroundColor='#e5e7eb';open_item.appendChild(open_box);open_item.appendChild(document.createTextNode(`Open: ${total-fulfilled}`));legend.appendChild(open_item);svg.parentElement.appendChild(legend)}function drawHorizontalBar(svgId,labels,data){const svg=document.getElementById(svgId);if(!svg)return;svg.innerHTML='';const max=Math.max(...data,1);const h=100/labels.length;labels.forEach((label,i)=>{const val=data[i];const w=val/max*150;const y=i*h+5;const rect=document.createElementNS('http://www.w3.org/2000/svg','rect');rect.setAttribute('x','40');rect.setAttribute('y',y);rect.setAttribute('width',w);rect.setAttribute('height',h-2);rect.setAttribute('fill',COLORS.danger);rect.setAttribute('rx','2');rect.style.cursor='pointer';rect.style.opacity='0.8';rect.addEventListener('mouseenter',()=>{rect.style.opacity='1';rect.style.filter='brightness(1.1)'});rect.addEventListener('mouseleave',()=>{rect.style.opacity='0.8';rect.style.filter='brightness(1)'});addTooltip(rect,`${label}: ₹${val.toLocaleString()}`);svg.appendChild(rect);const text=document.createElementNS('http://www.w3.org/2000/svg','text');text.setAttribute('x','5');text.setAttribute('y',y+h/2+3);text.setAttribute('font-size','9');text.setAttribute('fill','#666');text.textContent=label.substring(0,10);svg.appendChild(text)});const legend=document.createElement('div');legend.className='flex items-center gap-1 mt-2 text-xs';const box=document.createElement('div');box.className='w-3 h-3 rounded-sm';box.style.backgroundColor=COLORS.danger;legend.appendChild(box);legend.appendChild(document.createTextNode('Outstanding Amount'));svg.parentElement.appendChild(legend)}function drawVerticalBar(svgId,labels,data,color){const svg=document.getElementById(svgId);if(!svg)return;svg.innerHTML='';const max=Math.max(...data,1);const w=200/labels.length;data.forEach((val,i)=>{const h=val/max*70;const x=i*w+10;const y=80-h;const rect=document.createElementNS('http://www.w3.org/2000/svg','rect');rect.setAttribute('x',x);rect.setAttribute('y',y);rect.setAttribute('width',w-5);rect.setAttribute('height',h);rect.setAttribute('fill',color);rect.setAttribute('rx','2');rect.style.cursor='pointer';rect.style.opacity='0.8';rect.addEventListener('mouseenter',()=>{rect.style.opacity='1';rect.style.filter='brightness(1.1)'});rect.addEventListener('mouseleave',()=>{rect.style.opacity='0.8';rect.style.filter='brightness(1)'});addTooltip(rect,`${labels[i]}: ₹${val.toLocaleString()}`);svg.appendChild(rect);const text=document.createElementNS('http://www.w3.org/2000/svg','text');text.setAttribute('x',x+w/2-8);text.setAttribute('y','100');text.setAttribute('font-size','9');text.setAttribute('fill','#666');text.textContent=labels[i];svg.appendChild(text)});const legend=document.createElement('div');legend.className='flex items-center gap-1 mt-2 text-xs';const box=document.createElement('div');box.className='w-3 h-3 rounded-sm';box.style.backgroundColor=color;legend.appendChild(box);legend.appendChild(document.createTextNode('Outstanding Amount'));svg.parentElement.appendChild(legend)}function drawArea(svgId,label,value){const svg=document.getElementById(svgId);if(!svg)return;svg.innerHTML='';const path=`M 20 80 L 180 40 L 180 120 L 20 120 Z`;const pathEl=document.createElementNS('http://www.w3.org/2000/svg','path');pathEl.setAttribute('d',path);pathEl.setAttribute('fill',COLORS.primary);pathEl.setAttribute('opacity','0.2');svg.appendChild(pathEl);const line=document.createElementNS('http://www.w3.org/2000/svg','polyline');line.setAttribute('points','20,80 180,40');line.setAttribute('stroke',COLORS.primary);line.setAttribute('stroke-width','2');line.setAttribute('fill','none');line.style.cursor='pointer';addTooltip(line,`${label}: ₹${value.toLocaleString()}`);svg.appendChild(line);const circle=document.createElementNS('http://www.w3.org/2000/svg','circle');circle.setAttribute('cx','180');circle.setAttribute('cy','40');circle.setAttribute('r','3');circle.setAttribute('fill',COLORS.primary);circle.style.cursor='pointer';addTooltip(circle,`Latest: ₹${value.toLocaleString()}`);svg.appendChild(circle);const legend=document.createElement('div');legend.className='flex items-center gap-1 mt-2 text-xs';const box=document.createElement('div');box.className='w-3 h-3 rounded-sm';box.style.backgroundColor=COLORS.primary;legend.appendChild(box);legend.appendChild(document.createTextNode('Payment Trend'));svg.parentElement.appendChild(legend)}
function drawLine(svgId,dates,amounts){const svg=document.getElementById(svgId);if(!svg)return;svg.innerHTML='';if(!amounts||amounts.length===0){svg.innerHTML='<text x="100" y="65" text-anchor="middle" font-size="12" fill="#999">No data</text>';return}const max=Math.max(...amounts,1);const min=Math.min(...amounts,0);const range=max-min||1;const w=160/Math.max(amounts.length-1,1);const h=70;const points=amounts.map((val,i)=>{const x=20+i*w;const y=100-((val-min)/range)*h;return`${x},${y}`}).join(' ');const area=`M 20,100 L ${points} L ${20+w*(amounts.length-1)},100 Z`;const areaEl=document.createElementNS('http://www.w3.org/2000/svg','path');areaEl.setAttribute('d',area);areaEl.setAttribute('fill',COLORS.primary);areaEl.setAttribute('opacity','0.15');svg.appendChild(areaEl);const line=document.createElementNS('http://www.w3.org/2000/svg','polyline');line.setAttribute('points',points);line.setAttribute('stroke',COLORS.primary);line.setAttribute('stroke-width','2');line.setAttribute('fill','none');svg.appendChild(line);amounts.forEach((val,i)=>{const x=20+i*w;const y=100-((val-min)/range)*h;const circle=document.createElementNS('http://www.w3.org/2000/svg','circle');circle.setAttribute('cx',x);circle.setAttribute('cy',y);circle.setAttribute('r','2');circle.setAttribute('fill',COLORS.primary);circle.style.cursor='pointer';addTooltip(circle,`${dates[i]}: ₹${val.toLocaleString()}`);svg.appendChild(circle)});const legend=document.createElement('div');legend.className='flex items-center gap-1 mt-2 text-xs';const box=document.createElement('div');box.className='w-3 h-3 rounded-sm';box.style.backgroundColor=COLORS.primary;legend.appendChild(box);legend.appendChild(document.createTextNode('Invoice Amount'));svg.parentElement.appendChild(legend)}async function renderQuotations(prefix){const url=getApiUrl('/ergon/src/api/dashboard/quotations.php',prefix);const data=await apiGet(url)||{};const pending=safeNum(data.pending_count);const placed=safeNum(data.placed_count);const rejected=safeNum(data.rejected_count);const totalValue=safeNum(data.total_value);document.getElementById('quotationsTotal').textContent='₹'+totalValue.toLocaleString();document.getElementById('quotationsPending').textContent=pending;document.getElementById('quotationsPlaced').textContent=placed;document.getElementById('quotationsRejected').textContent=rejected;const container=document.getElementById('quotationsChart').parentElement;const existing=container.querySelector('.flex.flex-wrap');if(existing)existing.remove();drawDoughnut('quotationsChart',[pending,placed,rejected],[COLORS.warning,COLORS.success,COLORS.danger],['Draft','Sent','Approved'])}async function renderPurchaseOrders(prefix){const url=getApiUrl('/ergon/src/api/dashboard/purchase-orders.php',prefix);const data=await apiGet(url)||{};const open=safeNum(data.open_count);const fulfilled=safeNum(data.fulfilled);const totalVal=safeNum(data.total_value);const rate=safeNum(data.rate);document.getElementById('poTotal').textContent='₹'+totalVal.toLocaleString();document.getElementById('poOpen').textContent=open;document.getElementById('poFulfilled').textContent=fulfilled;document.getElementById('poFulfillmentRate').textContent=rate+'%';const container=document.getElementById('purchaseOrdersChart').parentElement;const existing=container.querySelector('.flex.gap-4');if(existing)existing.remove();drawGauge('purchaseOrdersChart',fulfilled,fulfilled+open)}async function renderInvoices(prefix){const url=getApiUrl('/ergon/src/api/dashboard/invoices.php',prefix);const data=await apiGet(url)||{};const paid=safeNum(data.paid);const unpaid=safeNum(data.unpaid);const overdue=safeNum(data.overdue);const totalVal=safeNum(data.total_value);document.getElementById('invoicesTotal').textContent='₹'+totalVal.toLocaleString();document.getElementById('invoicesPaid').textContent=paid;document.getElementById('invoicesUnpaid').textContent=unpaid;document.getElementById('invoicesOverdue').textContent=overdue;const container=document.getElementById('invoicesChart').parentElement;const existing=container.querySelector('.flex.flex-wrap');if(existing)existing.remove();drawDoughnut('invoicesChart',[paid,unpaid,overdue],[COLORS.success,COLORS.warning,COLORS.danger],['Paid','Unpaid','Overdue'])}async function renderOutstandingByCustomer(prefix){const url=getApiUrl('/ergon/src/api/dashboard/outstanding-by-customer.php',prefix);const rows=await apiGet(url)||[];const total=rows.reduce((s,r)=>s+safeNum(r.outstanding),0);document.getElementById('outstandingTotal').textContent='₹'+total.toLocaleString();document.getElementById('outstandingCustomers').textContent=rows.length;const labels=rows.slice(0,5).map(r=>String(r.customer_name||'').substring(0,12));const values=rows.slice(0,5).map(r=>safeNum(r.outstanding));const container=document.getElementById('outstandingByCustomerChart').parentElement;const existing=container.querySelector('.flex.items-center');if(existing)existing.remove();drawHorizontalBar('outstandingByCustomerChart',labels,values)}async function renderAgingBuckets(prefix){const url=getApiUrl('/ergon/src/api/dashboard/aging-buckets.php',prefix);const data=await apiGet(url)||{};const b0=safeNum(data.bucket_0_30);const b31=safeNum(data.bucket_31_60);const b61=safeNum(data.bucket_61_90);const b90=safeNum(data.bucket_90_plus);const total=b0+b31+b61+b90;document.getElementById('agingTotal').textContent='₹'+total.toLocaleString();document.getElementById('aging0to30').textContent=b0.toLocaleString();document.getElementById('aging31to60').textContent=b31.toLocaleString();document.getElementById('aging90plus').textContent=b90.toLocaleString();const container=document.getElementById('agingBucketsChart').parentElement;const existing=container.querySelector('.flex.items-center');if(existing)existing.remove();drawVerticalBar('agingBucketsChart',['0-30','31-60','61-90','90+'],[b0,b31,b61,b90],COLORS.success)}async function renderPayments(prefix){const url=getApiUrl('/ergon/src/api/dashboard/payments.php',prefix);const data=await apiGet(url)||{};const total=safeNum(data.total_paid??data.total_amount??0);const count=safeNum(data.payment_count);const avg=safeNum(data.avg_payment);document.getElementById('paymentsTotal').textContent='₹'+total.toLocaleString();document.getElementById('paymentCount').textContent=count;document.getElementById('paymentAvg').textContent='₹'+avg.toLocaleString();document.getElementById('paymentVelocity').textContent=count;const container=document.getElementById('paymentsChart').parentElement;const existing=container.querySelector('.flex.items-center');if(existing)existing.remove();drawArea('paymentsChart','Payments',total)}
async function renderInvoiceTrend(prefix){const url=getApiUrl('/ergon/src/api/dashboard/invoice-trend.php',prefix);const data=await apiGet(url)||{};const dates=data.dates||[];const amounts=data.amounts||[];const total=amounts.reduce((a,b)=>a+b,0);const avg=amounts.length>0?total/amounts.length:0;const peak=Math.max(...amounts,0);document.getElementById('invoiceTrendTotal').textContent='₹'+total.toLocaleString();document.getElementById('invoiceTrendDays').textContent=dates.length;document.getElementById('invoiceTrendAvg').textContent='₹'+Math.round(avg).toLocaleString();document.getElementById('invoiceTrendPeak').textContent='₹'+peak.toLocaleString();const container=document.getElementById('invoiceTrendChart').parentElement;const existing=container.querySelector('.flex.items-center');if(existing)existing.remove();drawLine('invoiceTrendChart',dates,amounts)}
async function renderAllCharts(prefix){if(!prefix)return;await Promise.all([renderQuotations(prefix),renderPurchaseOrders(prefix),renderInvoiceTrend(prefix),renderOutstandingByCustomer(prefix),renderAgingBuckets(prefix),renderPayments(prefix)])}window._dashboardCharts={renderAllCharts};
